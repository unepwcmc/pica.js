(function(){window.Pica||(window.Pica={}),Pica.Events=function(){function t(){}return t.prototype.on=function(t,e){var r;return this.events||(this.events={}),(r=this.events)[t]||(r[t]=[]),this.events[t].push(e)},t.prototype.off=function(t,e){var r,o,n,s,i,a;if(null!=this.events){if(null==t)return this.events=[];if(null!=this.events[t]){if(null!=e){for(i=this.events[t],a=[],o=n=0,s=i.length;s>n;o=++n)r=i[o],r===e?(this.events[t].splice(o,1),a.push(o-=1)):a.push(void 0);return a}return delete this.events[t]}}},t.prototype.trigger=function(t,e){var r,o,n,s,i;if(null!=this.events&&null!=this.events[t]){for(s=this.events[t],i=[],o=0,n=s.length;n>o;o++)r=s[o],i.push(r.apply(this,[].concat(e)));return i}},t}()}).call(this),function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r={}.hasOwnProperty,o=function(t,e){function o(){this.constructor=t}for(var n in e)r.call(e,n)&&(t[n]=e[n]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t};Pica.Model=function(r){function n(){return this.destroy=e(this.destroy,this),this.fetch=e(this.fetch,this),this.save=e(this.save,this),t=n.__super__.constructor.apply(this,arguments)}return o(n,r),n.prototype.throwIfNoApp=function(){if(null==this.app)throw"Cannot create a Pica.Model without specifying a Pica.Application"},n.prototype.url=function(){},n.prototype.get=function(t){var e;return null==(e=this.attributes)&&(this.attributes={}),this.attributes[t]},n.prototype.set=function(t,e){var r;return null==(r=this.attributes)&&(this.attributes={}),this.attributes[t]=e,this.trigger("change")},n.prototype.sync=function(t){var e,r,o,n=this;return null==t&&(t={}),o=t.success||function(){},t.success=function(t,e,r){return null!=t.id&&(n.parse(t),n.trigger("sync",n)),n.app.notifySyncFinished(),o(n,e,r)},r=t.error||function(){},t.error=function(t,e,o){return n.app.notifySyncFinished(),r(n,e,o)},("post"===t.type||"put"===t.type)&&(e=this.attributes,"post"===t.type&&(e=JSON.stringify(e))),"delete"===t.type&&(e=null),this.app.notifySyncStarted(),$.ajax($.extend(t,{contentType:"application/json",dataType:"json",data:e}))},n.prototype.parse=function(t){var e,r,o;o=[];for(e in t)r=t[e],o.push(this.set(e,r));return o},n.prototype.save=function(t){var e,r=this;return null==t&&(t={}),null!=this.get("id")?(t.url=null!=this.url().read?this.url().read:this.url(),t.type="put"):(t.url=null!=this.url().create?this.url().create:this.url(),t.type="post"),e=this.sync(t),e.done(function(){return console.log("saving "+r.constructor.name+" "+r.get("id"))}),e},n.prototype.fetch=function(t){return null==t&&(t={}),t.url=null!=this.url().read?this.url().read:this.url(),console.log("fetching "+this.constructor.name+" "+this.get("id")),this.sync(t)},n.prototype.destroy=function(t){var e,r=this;return null==t&&(t={}),t.url=null!=this.url().read?this.url().read:this.url(),t.type="delete",e=t.success,t.success=function(){return r.trigger("delete"),console.log("deleted "+r.constructor.name+" "+r.get("id")),e&&e(),r.off()},this.sync(t)},n}(Pica.Events)}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,r=function(t,r){function o(){this.constructor=t}for(var n in r)e.call(r,n)&&(t[n]=r[n]);return o.prototype=r.prototype,t.prototype=new o,t.__super__=r.prototype,t};window.Pica||(window.Pica={}),Pica.Models={},Pica.Views={},Pica.Application=function(e){function o(e){this.config=e,this.parse=t(this.parse,this),Pica.config=this.config,$.support.cors=!0,$.ajaxSetup({headers:{"X-Magpie-ProjectId":Pica.config.projectId}}),this.layers=[],this.fetch(),this.config.delegateLayerControl&&this.showTileLayers()}return r(o,e),o.prototype.newWorkspace=function(){return this.currentWorkspace=new Pica.Models.Workspace(this)},o.prototype.showTileLayers=function(){return new Pica.Views.ShowLayersView({app:this})},o.prototype.fetch=function(){return $.ajax({url:""+Pica.config.magpieUrl+"/projects/"+Pica.config.projectId+".json",type:"get",success:this.parse})},o.prototype.parse=function(t){var e,r;for(e in t)r=t[e],this[e]=r;return this.trigger("sync")},o.prototype.notifySyncStarted=function(){return this.syncsInProgress||(this.syncsInProgress=0),this.syncsInProgress=this.syncsInProgress+1,1===this.syncsInProgress?this.trigger("syncStarted"):void 0},o.prototype.notifySyncFinished=function(){return this.syncsInProgress||(this.syncsInProgress=0),this.syncsInProgress=this.syncsInProgress-1,0===this.syncsInProgress?this.trigger("syncFinished"):void 0},o}(Pica.Events)}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,r=function(t,r){function o(){this.constructor=t}for(var n in r)e.call(r,n)&&(t[n]=r[n]);return o.prototype=r.prototype,t.prototype=new o,t.__super__=r.prototype,t};Pica.Models.Area=function(e){function o(e){this.app=e,this.save=t(this.save,this),this.getAreaId=t(this.getAreaId,this),this.throwIfNoApp(),this.polygons=[],this.set("name","My Lovely Area")}return r(o,e),o.prototype.setName=function(t){return this.set("name",t)},o.prototype.addPolygon=function(t){var e=this;return t.on("requestAreaId",this.getAreaId),t.on("sync",function(){return e.fetch()}),t.on("delete",function(){return e.fetch()}),this.polygons.push(t),this.trigger("addedPolygon",t)},o.prototype.getAreaId=function(t){return null!=this.get("id")?t.success(this):this.save(t)},o.prototype.drawNewPolygonView=function(t){return this.createPolygon(),new Pica.Views.NewPolygonView({callbacks:t,polygon:this.currentPolygon})},o.prototype.drawNewCircleView=function(t){return this.createPolygon(),new Pica.Views.NewCircleView({callbacks:t,polygon:this.currentPolygon})},o.prototype.createPolygon=function(){return this.currentPolygon=new Pica.Models.Polygon(this.app),this.addPolygon(this.currentPolygon)},o.prototype.newUploadFileView=function(t){return new Pica.Views.UploadFileView({callbacks:t,area:this})},o.prototype.newShowAreaPolygonsView=function(){return new Pica.Views.ShowAreaPolygonsView({area:this})},o.prototype.url=function(){var t;return t=Pica.config.magpieUrl,{create:""+t+"/workspaces/"+this.get("workspace_id")+"/areas_of_interest.json",read:""+t+"/areas_of_interest/"+this.get("id")+".json"}},o.prototype.parse=function(t){var e,r,n,s,i,a,c,l,u,p;if(null!=t.polygons){for(this.polygons=[],u=t.polygons,i=0,c=u.length;c>i;i++)n=u[i],r=new Pica.Models.Polygon({attributes:n}),this.addPolygon(r);delete t.polygons}else{for(s=[],p=this.polygons,e=a=0,l=p.length;l>a;e=++a)r=p[e],null==r.get("id")&&s.push(r);this.polygons=s}return o.__super__.parse.apply(this,arguments)},o.prototype.save=function(t){var e=this;return t||(t={}),null!=this.get("workspace_id")?o.__super__.save.call(this,t):this.trigger("requestWorkspaceId",{success:function(r,o,n){return e.set("workspace_id",r.get("id")),e.get("workspace_id")?e.save(t):t.error(e,{error:"Could not save workspace, so cannot save area"},n)},error:function(e,r,o){return console.log("Unable to save area:"),console.log(arguments),console.log(e.status),console.log(e.statusText),console.log(e.responseText),null!=t.error?t.error(e,r,{error:"Unable to obtain workspaceId, cannot save area",parentError:o}):void 0}})},o}(Pica.Model)}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,r=function(t,r){function o(){this.constructor=t}for(var n in r)e.call(r,n)&&(t[n]=r[n]);return o.prototype=r.prototype,t.prototype=new o,t.__super__=r.prototype,t};Pica.Models.Polygon=function(e){function o(e,r){var o;this.app=e,null==r&&(r={}),this.save=t(this.save,this),this.throwIfNoApp(),this.attributes=null!=r.attributes?r.attributes:{},(o=this.attributes).geometry||(o.geometry={type:"Polygon"})}return r(o,e),o.prototype.isComplete=function(){return null!=this.get("geometry").coordinates},o.prototype.setGeomFromPoints=function(t){var e;return t=function(){var r,o,n;for(n=[],r=0,o=t.length;o>r;r++)e=t[r],n.push([e.lng,e.lat]);return n}(),t.push(t[0]),this.set("geometry",{type:"Polygon",coordinates:[t]})},o.prototype.setGeomFromCircle=function(t,e){return this.set("geometry",{type:"Circle",coordinates:[t.lng,t.lat],radius:e})},o.prototype.asLeafletArguments=function(){var t,e,r,o,n,s;if(t=[],"Polygon"===this.get("geometry").type){if(e=[],this.isComplete())for(s=this.get("geometry").coordinates[0],o=0,n=s.length;n>o;o++)r=s[o],e.push(new L.LatLng(r[1],r[0]));t.push(e)}else this.isComplete()?(r=this.get("geometry").coordinates,t=[new L.LatLng(r[1],r[0]),this.get("geometry").radius]):t=[[],0];return t},o.prototype.url=function(){var t;return t=Pica.config.magpieUrl,{read:""+t+"/polygons/"+this.get("id")+".json",create:""+t+"/areas_of_interest/"+this.get("area_id")+"/polygons.json"}},o.prototype.save=function(t){var e=this;return t||(t={}),null!=this.get("area_id")?o.__super__.save.call(this,t):this.trigger("requestAreaId",{success:function(r,o,n){return e.set("area_id",r.get("id")),e.get("area_id")?e.save(t):null!=t.error?t.error(e,{error:"Unable to get area id, so cannot save polygon"},n):void 0},error:function(e,r,o){return console.log("Unable to save polygon:"),console.log(arguments),console.log(e.status),console.log(e.statusText),console.log(e.responseText),null!=t.error?t.error(e,r,{error:"Unable to obtain areaId, cannot save polygon",parentError:o}):void 0}})},o}(Pica.Model)}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,r=function(t,r){function o(){this.constructor=t}for(var n in r)e.call(r,n)&&(t[n]=r[n]);return o.prototype=r.prototype,t.prototype=new o,t.__super__=r.prototype,t};Pica.Models.Workspace=function(e){function o(e){this.app=e,this.save=t(this.save,this),this.throwIfNoApp(),this.attributes={},this.areas=[],this.currentArea=new Pica.Models.Area(this.app),this.addArea(this.currentArea)}return r(o,e),o.prototype.url=function(){return""+Pica.config.magpieUrl+"/workspaces.json"},o.prototype.addArea=function(t){var e=this;return t.on("requestWorkspaceId",function(t){return null!=e.get("id")?t.success(e):e.save(t)}),this.areas.push(t)},o.prototype.removeArea=function(t){var e,r;return r=this.areas.indexOf(t),e=this.areas.splice(r,1)[0],null!=e.get("id")?e.destroy():void 0},o.prototype.setCurrentArea=function(t){var e,r,o,n,s;for(n=this.areas,s=[],r=0,o=n.length;o>r;r++)e=n[r],e===t?s.push(this.currentArea=e):s.push(void 0);return s},o.prototype.setCurrentAreaById=function(t){var e,r,o,n,s;for(n=this.areas,s=[],r=0,o=n.length;o>r;r++)e=n[r],e.get("id")===t?s.push(this.currentArea=e):s.push(void 0);return s},o.prototype.save=function(t){return o.__super__.save.call(this,t)},o}(Pica.Model)}.call(this),function(){Pica.Views.NewCircleView=function(){function t(t){var e=this;null!=t.callbacks&&(this.successCallback=t.callbacks.success,this.errorCallback=t.callbacks.error),this.polygon=t.polygon,this.polygon.set("geometry",{type:"Circle"}),this.polygonDraw=new L.Circle.Draw(Pica.config.map,{}),this.polygonDraw.enable(),Pica.config.map.on("draw:circle-created",function(t){return e.createPolygon(t.circ)})}return t.prototype.createPolygon=function(t){var e=this;return this.polygon.setGeomFromCircle(t.getLatLng(),t.getRadius()),this.polygon.save({success:function(){return e.close(),null!=e.successCallback?e.successCallback():void 0},error:function(){return e.close(),null!=e.errorCallback?e.errorCallback.apply(e,arguments):void 0}})},t.prototype.close=function(){return this.polygonDraw.disable(),Pica.config.map.off("draw:circle-created")},t}()}.call(this),function(){Pica.Views.NewPolygonView=function(){function t(t){var e=this;null!=t.callbacks&&(this.successCallback=t.callbacks.success,this.errorCallback=t.callbacks.error),this.polygon=t.polygon,this.polygonDraw=new L.Polygon.Draw(Pica.config.map,{}),this.polygonDraw.enable(),Pica.config.map.on("draw:poly-created",function(t){var r;return r=t.poly,e.createPolygon(r)})}return t.prototype.createPolygon=function(t){var e=this;return this.polygon.setGeomFromPoints(t.getLatLngs()),this.polygon.save({success:function(){return e.close(),null!=e.successCallback?e.successCallback():void 0},error:function(){return e.close(),null!=e.errorCallback?e.errorCallback.apply(e,arguments):void 0}})},t.prototype.close=function(){return this.polygonDraw.disable(),Pica.config.map.off("draw:poly-created")},t}()}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,r=function(t,r){function o(){this.constructor=t}for(var n in r)e.call(r,n)&&(t[n]=r[n]);return o.prototype=r.prototype,t.prototype=new o,t.__super__=r.prototype,t};Pica.Views.ShowAreaPolygonsView=function(e){function o(e){this.triggerPolyClick=t(this.triggerPolyClick,this),this.addPolygon=t(this.addPolygon,this),this.render=t(this.render,this),this.area=e.area,this.polysObserved=[],this.mapPolygons=[],this.area.on("sync",this.render),this.area.on("addedPolygon",this.addPolygon),this.render()}return r(o,e),o.prototype.render=function(){var t,e,r,o,n,s,i,a=this;for(this.removeAllPolygonsAndBindings(),s=this.area.polygons,i=[],o=0,n=s.length;n>o;o++)r=s[o],r.isComplete()&&(e=function(t,e){var r;return r=function(e){return t.apply(this,e)},r.prototype=t.prototype,new r(e)},t=e(L[r.get("geometry").type],r.asLeafletArguments()).addTo(Pica.config.map),r.on("delete",function(){var e;return e=t,function(){return a.removeMapPolygonAndBindings(e)}}()),t.on("click",function(){var e,o;return o=r,e=t,function(t){return a.triggerPolyClick(o,t,e)}}()),i.push(this.mapPolygons.push(t)));return i},o.prototype.addPolygon=function(t){return t.on("change",this.render),this.polysObserved.push(t)},o.prototype.close=function(){var t,e,r,o,n;for(this.removeAllPolygonsAndBindings(),this.area.off("sync",this.render),this.area.off("addedPolygon",this.addPolygon),o=this.polysObserved,n=[],e=0,r=o.length;r>e;e++)t=o[e],n.push(t.off("change",this.render));return n},o.prototype.removeAllPolygonsAndBindings=function(){var t,e;for(e=[];t=this.mapPolygons.shift();)e.push(this.removeMapPolygonAndBindings(t));return e},o.prototype.removeMapPolygonAndBindings=function(t){return t.off("click",this.triggerPolyClicked),Pica.config.map.removeLayer(t)},o.prototype.triggerPolyClick=function(t,e,r){return this.trigger("polygonClick",[t,e,r])},o}(Pica.Events)}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};Pica.Views.ShowLayersView=function(){function e(e){this.removeTileLayers=t(this.removeTileLayers,this),this.render=t(this.render,this),this.app=e.app,this.app.on("sync",this.render),this.tileLayers={},this.layerControl=!1}return e.prototype.render=function(){var t,e,r,o,n;for(this.removeTileLayers(),this.removeLayerControl(),n=this.app.layers,r=0,o=n.length;o>r;r++)t=n[r],e=L.tileLayer(t.tile_url),this.tileLayers[t.display_name]=e,this.app.config.delegateLayerControl||e.addTo(this.app.config.map);return this.app.config.delegateLayerControl?this.layerControl=this.renderLayerControl(this.app.config.map):void 0},e.prototype.renderLayerControl=function(t){var e,r;return e=this.app.config.extraOverlays||{},r=$.extend(this.tileLayers,e),this.showFirstOverlay(r,t),L.control.layers({},r).addTo(t)},e.prototype.showFirstOverlay=function(t,e){var r,o;for(o in t)return r=t[o],r.addTo(e),void 0},e.prototype.removeTileLayers=function(){var t,e,r,o;r=this.tileLayers,o=[];for(t in r)e=r[t],o.push(this.app.map.removeLayer(e));return o},e.prototype.removeLayerControl=function(){var t;return null!=(t=this.layerControl)?t.removeFrom(this.app.map):void 0},e.prototype.close=function(){return this.removeTileLayers(),this.removeLayerControl(),this.app.off("sync",this.render)},e}()}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,r=function(t,r){function o(){this.constructor=t}for(var n in r)e.call(r,n)&&(t[n]=r[n]);return o.prototype=r.prototype,t.prototype=new o,t.__super__=r.prototype,t};Pica.Views.UploadFileView=function(e){function o(e){this.onUploadComplete=t(this.onUploadComplete,this),this.render=t(this.render,this),null!=e.callbacks&&(this.successCallback=e.callbacks.success,this.errorCallback=e.callbacks.error),this.area=e.area,this.el=document.createElement("div"),this.area.getAreaId({success:this.render})}return r(o,e),o.prototype.render=function(){var t;return t=document.createElement("iframe"),t.src=""+Pica.config.magpieUrl+"/areas_of_interest/"+this.area.get("id")+"/polygons/new_upload_form/",t.className="pica-upload-form",this.el.appendChild(t),window.addEventListener("message",this.onUploadComplete,!1)},o.prototype.onUploadComplete=function(t){return t.origin===Pica.config.magpieUrl&&null!=t.data.polygonImportStatus?("Successful import"===t.data.polygonImportStatus&&null!=this.successCallback?this.successCallback(t.data.polygonImportStatus,t.data.importMessages):null!=this.errorCallback&&this.errorCallback(t.data.polygonImportStatus,t.data.importMessages),this.close()):void 0},o.prototype.close=function(){return window.removeEventListener("message",this.onUploadComplete),$(this.el).remove()},o}(Pica.Events)}.call(this);